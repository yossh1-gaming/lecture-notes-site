<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>講義録アップロード</title>
</head>
<body>
  <h1>講義録アップロード</h1>

  <input type="text" id="title" placeholder="タイトル"><br>
  <input type="text" id="subject" placeholder="講義名"><br>
  <input type="file" id="file"><br>
  <button onclick="upload()">アップロード</button>

  <h2>アップロード済み講義録</h2>
  <ul id="list"></ul>

  <script type="module">
    import { supabase } from './supabase.js'

    async function upload() {
      const title = document.getElementById("title").value
      const subject = document.getElementById("subject").value
      const file = document.getElementById("file").files[0]

      if (!title || !file) {
        alert("タイトルとファイルは必須です")
        return
      }

      const filename = `${Date.now()}-${file.name}`

      // Storage にファイルをアップロード
      const { data: fileData, error: fileErr } = await supabase
        .storage
        .from("lecture-files")
        .upload(filename, file)

      if (fileErr) {
        alert("ファイルアップロード失敗：" + fileErr.message)
        return
      }

      // 公開URL取得
      const { publicUrl } = supabase
        .storage
        .from("lecture-files")
        .getPublicUrl(fileData.path).data

      // データベースに登録
      const { error: dbErr } = await supabase
        .from("notes")
        .insert({
          title,
          subject,
          file_url: publicUrl
        })

      if (dbErr) {
        alert("データ保存失敗：" + dbErr.message)
        return
      }

      alert("アップロード成功！")
      loadNotes()
    }

    async function loadNotes() {
      const { data: notes } = await supabase
        .from("notes")
        .select("*")
        .order("created_at", { ascending: false })

      const ul = document.getElementById("list")
      ul.innerHTML = ""
      notes.forEach(note => {
        const li = document.createElement("li")
        li.innerHTML = `<a href="${note.file_url}" target="_blank">${note.title}（${note.subject}）</a>`
        ul.appendChild(li)
      })
    }

    loadNotes()
  </script>
</body>
</html>
